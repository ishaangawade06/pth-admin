<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTH Admin — ProTraderHack</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#071125; color:#e6eef8; font-family:Inter, Arial; }
    .card { background:#0f1724; padding:16px; border-radius:10px; }
    .muted { color:#9aa6b2; font-size:13px; }
    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:0 }
    .btn-primary { background:#2563eb; color:white }
    .btn-green { background:#10b981; color:white }
    .btn-red { background:#ef4444; color:white }
    .small { font-size:13px; color:#9aa6b2; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media(min-width:960px){ .grid { grid-template-columns: 1fr 1fr 1fr; } }
    .list { max-height:420px; overflow:auto; padding-right:6px; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
    .chip { padding:6px 8px; border-radius:8px; font-weight:600; }
    .status-processing { background:#f59e0b; color:black }
    .status-completed { background:#10b981; color:white }
    .status-cancelled { background:#ef4444; color:white }
  </style>
</head>
<body class="p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-green-300">ProTraderHack — Admin</h1>
        <div class="muted">Owner tools · manage keys · view signals · broadcast notifications</div>
      </div>
      <div>
        <button id="logoutBtn" class="btn btn-red hidden">Logout</button>
      </div>
    </div>

    <!-- Login Card -->
    <div id="loginCard" class="card max-w-md mx-auto mb-6">
      <h2 class="text-lg font-semibold mb-3">Admin Login</h2>
      <input id="admEmail" placeholder="Email" class="w-full p-2 mb-2 rounded bg-gray-900" />
      <input id="admPass" placeholder="Password" type="password" class="w-full p-2 mb-3 rounded bg-gray-900" />
      <div class="flex gap-2">
        <button id="admLogin" class="btn btn-primary">Login</button>
        <button id="quickTest" class="btn btn-green">Quick Test (fetch)</button>
      </div>
      <p class="small mt-3">Use an admin account (owner keys: <code>vamya</code>, <code>pthowner16</code>)</p>
    </div>

    <!-- Main Dashboard -->
    <div id="panel" class="hidden">
      <div class="grid">
        <!-- Keys card -->
        <div class="card">
          <h3 class="font-semibold mb-2">Active Keys</h3>
          <div class="list" id="keysList"></div>

          <div class="mt-3">
            <input id="newKeyVal" placeholder="Key string (e.g. pth7)" class="w-full p-2 mb-2 rounded bg-gray-900" />
            <select id="newKeyDays" class="w-full mb-2 p-2 rounded bg-gray-900">
              <option value="">Permanent</option>
              <option value="7">7 days</option>
              <option value="15">15 days</option>
              <option value="30">30 days</option>
            </select>
            <div class="flex gap-2">
              <button id="createKeyBtn" class="btn btn-green w-full">Create Key</button>
              <button id="deleteExpiredBtn" class="btn" style="background:#334155;color:#fff">Delete Expired</button>
            </div>
          </div>
        </div>

        <!-- Signals card -->
        <div class="card">
          <h3 class="font-semibold mb-2">Signals (recent)</h3>
          <div class="list" id="signalsList"></div>

          <hr class="my-3 border-gray-700" />
          <h4 class="font-semibold mb-2">Broadcast Notification</h4>
          <input id="broadcastMessage" placeholder="Message (optional)" class="w-full p-2 mb-2 rounded bg-gray-900" />
          <input id="broadcastSymbol" placeholder="Symbol (e.g. BTC/USDT or INFY-NSE)" class="w-full p-2 mb-2 rounded bg-gray-900" />
          <div class="flex gap-2 mb-2">
            <select id="broadcastSignal" class="p-2 rounded bg-gray-900">
              <option value="INFO">INFO</option>
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
              <option value="HOLD">HOLD</option>
            </select>
            <input id="broadcastPrice" placeholder="Price (optional)" class="p-2 rounded bg-gray-900" />
          </div>
          <div class="flex gap-2">
            <button id="broadcastBtn" class="btn btn-primary">Send Broadcast</button>
            <button id="broadcastTest" class="btn" style="background:#475569;color:#fff">Send Test</button>
          </div>
        </div>

        <!-- Transactions card -->
        <div class="card">
          <h3 class="font-semibold mb-2">Transactions</h3>
          <div class="list" id="txnList"></div>
          <div class="mt-3 small muted">Refresh below to get latest. You can change status per entry.</div>
          <div class="flex gap-2 mt-3">
            <button id="refreshTxBtn" class="btn btn-primary">Refresh</button>
            <button id="exportCsv" class="btn" style="background:#334155;color:#fff">Export CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== CONFIG =====
    const BACKEND = "https://protrader-backend-sbus.onrender.com";
    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.firebasestorage.app",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== UI elements =====
    const loginCard = document.getElementById('loginCard');
    const panel = document.getElementById('panel');
    const logoutBtn = document.getElementById('logoutBtn');

    // ===== Admin login =====
    document.getElementById('admLogin').onclick = async ()=>{
      const e = document.getElementById('admEmail').value;
      const p = document.getElementById('admPass').value;
      try {
        await auth.signInWithEmailAndPassword(e,p);
      } catch (err) { alert('Login failed: '+err.message); }
    };

    auth.onAuthStateChanged(async user=>{
      if (!user) {
        loginCard.style.display = '';
        panel.style.display = 'none';
        logoutBtn.classList.add('hidden');
      } else {
        loginCard.style.display = 'none';
        panel.style.display = '';
        logoutBtn.classList.remove('hidden');
        loadKeys(); loadSignals(); loadTransactions();
      }
    });

    logoutBtn.onclick = ()=>auth.signOut();

    // ===== Keys management =====
    async function loadKeys(){
      const el = document.getElementById('keysList'); el.innerHTML = '';
      const snap = await db.collection('keys').orderBy('expiry', 'asc').get();
      snap.forEach(d=>{
        const data = d.data();
        const id = d.id;
        const expiry = data.expiry || 'never';
        const role = data.role || 'user';
        const row = document.createElement('div'); row.className='row';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${id}</strong><div class="muted">${role} • exp: ${expiry}</div></div>`;
        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className='btn btn-red'; del.innerText='Delete'; del.onclick = async ()=>{ if(!confirm('Delete key?')) return; await db.collection('keys').doc(id).delete(); loadKeys(); };
        right.appendChild(del);
        row.appendChild(left); row.appendChild(right);
        el.appendChild(row);
      });
    }

    document.getElementById('createKeyBtn').onclick = async ()=>{
      const k = document.getElementById('newKeyVal').value.trim();
      const days = document.getElementById('newKeyDays').value;
      if(!k){ alert('Enter key string'); return; }
      const expiry = days ? new Date(Date.now() + days*24*3600*1000).toISOString() : null;
      await db.collection('keys').doc(k).set({ role:'user', expiry });
      document.getElementById('newKeyVal').value=''; document.getElementById('newKeyDays').value='';
      alert('Key created: '+k);
      loadKeys();
    };

    document.getElementById('deleteExpiredBtn').onclick = async ()=>{
      const snap = await db.collection('keys').get();
      let count = 0;
      snap.forEach(d=>{
        const data = d.data();
        if(data.expiry){
          const exp = new Date(data.expiry);
          if(exp < new Date()){
            db.collection('keys').doc(d.id).delete();
            count++;
          }
        }
      });
      alert('Deleted expired keys: '+count);
      loadKeys();
    };

    // ===== Signals feed =====
    function loadSignals(){
      const el = document.getElementById('signalsList'); el.innerHTML = '';
      db.collection('signals').orderBy('timestamp','desc').limit(50).onSnapshot(snap=>{
        el.innerHTML='';
        snap.forEach(d=>{
          const s = d.data();
          const row = document.createElement('div'); row.className='row';
          const left = document.createElement('div');
          left.innerHTML = `<div><strong>${s.symbol}</strong> <span class="muted">${s.signal}</span><div class="small muted">${s.meta?.timestamp || s.timestamp}</div></div>`;
          row.appendChild(left);
          el.appendChild(row);
        });
      });
    }

    // ===== Broadcast =====
    document.getElementById('broadcastBtn').onclick = async ()=>{
      const msg = document.getElementById('broadcastMessage').value.trim();
      const symbol = document.getElementById('broadcastSymbol').value.trim() || 'GENERIC';
      const signal = document.getElementById('broadcastSignal').value;
      const price = document.getElementById('broadcastPrice').value.trim() || '-';
      const body = { message: msg, symbol, signal, price };
      try {
        const res = await fetch(BACKEND + '/send_notification', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        alert('Broadcast sent to ' + (data.sent_to || 0) + ' active keys.');
      } catch (e) { alert('Broadcast failed: ' + e.message); }
    };

    document.getElementById('broadcastTest').onclick = async ()=>{
      document.getElementById('broadcastMessage').value='Test notification from admin';
      document.getElementById('broadcastSymbol').value='TEST-1';
      document.getElementById('broadcastSignal').value='INFO';
      document.getElementById('broadcastPrice').value='-';
      document.getElementById('broadcastBtn').click();
    };

    // ===== Transactions =====
    async function loadTransactions(){
      const el = document.getElementById('txnList'); el.innerHTML = 'Loading...';
      try {
        const res = await fetch(BACKEND + '/transactions');
        const data = await res.json();
        el.innerHTML = '';
        if(!Array.isArray(data) || data.length===0){ el.innerHTML = '<div class="small muted">No transactions</div>'; return; }
        data.forEach(t=>{
          const row = document.createElement('div'); row.className='row';
          const left = document.createElement('div');
          left.innerHTML = `<div><strong>${t.user}</strong><div class="muted">${t.type} • ${t.broker} • ${t.timestamp}</div></div>`;
          const right = document.createElement('div');
          // status chip
          const chip = document.createElement('span');
          chip.className='chip ' + (t.status==='processing' ? 'status-processing' : t.status==='completed' ? 'status-completed' : 'status-cancelled');
          chip.innerText = t.status.toUpperCase();
          right.appendChild(chip);
          // actions
          const btnComplete = document.createElement('button'); btnComplete.className='btn btn-green'; btnComplete.style.marginLeft='8px'; btnComplete.innerText='Mark Completed';
          btnComplete.onclick = async ()=>{ await updateTxStatus(t.id, 'completed'); loadTransactions(); };
          const btnProc = document.createElement('button'); btnProc.className='btn'; btnProc.style.marginLeft='8px'; btnProc.innerText='Mark Processing';
          btnProc.onclick = async ()=>{ await updateTxStatus(t.id, 'processing'); loadTransactions(); };
          const btnCancel = document.createElement('button'); btnCancel.className='btn btn-red'; btnCancel.style.marginLeft='8px'; btnCancel.innerText='Mark Cancelled';
          btnCancel.onclick = async ()=>{ if(!confirm('Mark cancelled?')) return; await updateTxStatus(t.id, 'cancelled'); loadTransactions(); };
          right.appendChild(btnComplete); right.appendChild(btnProc); right.appendChild(btnCancel);

          row.appendChild(left); row.appendChild(right);
          el.appendChild(row);
        });
      } catch (e) {
        el.innerHTML = '<div class="small muted">Error loading transactions: '+e.message+'</div>';
      }
    }

    document.getElementById('refreshTxBtn').onclick = loadTransactions;

    async function updateTxStatus(id, status){
      try {
        await db.collection('transactions').doc(id).update({ status });
        alert('Status updated: ' + status);
      } catch (e) {
        alert('Update failed: '+e.message);
      }
    }

    document.getElementById('exportCsv').onclick = async ()=>{
      // fetch and convert to CSV
      const res = await fetch(BACKEND + '/transactions');
      const data = await res.json();
      if(!Array.isArray(data) || data.length===0){ alert('No transactions'); return; }
      const rows = [ ['id','user','broker','type','status','timestamp'] ];
      data.forEach(r=> rows.push([r.id, r.user, r.broker, r.type, r.status, r.timestamp]));
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'transactions.csv'; a.click(); URL.revokeObjectURL(url);
    };

    // Quick test trigger
    document.getElementById('quickTest').onclick = ()=>{ loadTransactions(); loadKeys(); loadSignals(); };

    // Initial no-op to ensure auth state reacts properly
    // (no automatic sign-in; admin must sign in)
  </script>
</body>
  </html>
