<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTH Admin — ProTraderHack</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background:#071125; color:#e6eef8; font-family:Inter, Arial; }
    .card { background:#0f1724; padding:16px; border-radius:10px; }
    .muted { color:#9aa6b2; font-size:13px; }
    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:0 }
    .btn-primary { background:#2563eb; color:white }
    .btn-green { background:#10b981; color:white }
    .btn-red { background:#ef4444; color:white }
    .small { font-size:13px; color:#9aa6b2; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media(min-width:960px){ .grid { grid-template-columns: 1fr 1fr 1fr; } }
    .list { max-height:420px; overflow:auto; padding-right:6px; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
    .chip { padding:6px 8px; border-radius:8px; font-weight:600; }
    .status-processing { background:#f59e0b; color:black }
    .status-completed { background:#10b981; color:white }
    .status-cancelled { background:#ef4444; color:white }
  </style>
</head>
<body class="p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-green-300">ProTraderHack — Admin</h1>
        <div class="muted">Owner tools · manage keys · view signals · broadcast notifications</div>
      </div>
      <div>
        <button id="logoutBtn" class="btn btn-red hidden">Logout</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card max-w-md mx-auto mb-6">
      <h2 class="text-lg font-semibold mb-3">Admin Login</h2>
      <input id="admEmail" placeholder="Email" class="w-full p-2 mb-2 rounded bg-gray-900" />
      <input id="admPass" placeholder="Password" type="password" class="w-full p-2 mb-3 rounded bg-gray-900" />
      <button id="admLogin" class="btn btn-primary w-full">Login</button>
      <p class="small mt-3">Use an admin account</p>
    </div>

    <!-- Main Dashboard -->
    <div id="panel" class="hidden">
      <div class="grid">
        <!-- Keys -->
        <div class="card">
          <h3 class="font-semibold mb-2">Active Keys</h3>
          <div class="list" id="keysList"></div>
          <div class="mt-3">
            <input id="newKeyVal" placeholder="Key string" class="w-full p-2 mb-2 rounded bg-gray-900" />
            <select id="newKeyDays" class="w-full mb-2 p-2 rounded bg-gray-900">
              <option value="">Permanent</option>
              <option value="7">7 days</option>
              <option value="15">15 days</option>
              <option value="30">30 days</option>
            </select>
            <button id="createKeyBtn" class="btn btn-green w-full">Create Key</button>
          </div>
        </div>

        <!-- Signals -->
        <div class="card">
          <h3 class="font-semibold mb-2">Signals</h3>
          <div class="list" id="signalsList"></div>
          <hr class="my-3 border-gray-700" />
          <h4 class="font-semibold mb-2">Broadcast Notification</h4>
          <input id="broadcastMessage" placeholder="Message" class="w-full p-2 mb-2 rounded bg-gray-900" />
          <input id="broadcastSymbol" placeholder="Symbol (e.g. BTC/USDT)" class="w-full p-2 mb-2 rounded bg-gray-900" />
          <select id="broadcastSignal" class="w-full p-2 mb-2 rounded bg-gray-900">
            <option value="INFO">INFO</option>
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
            <option value="HOLD">HOLD</option>
          </select>
          <input id="broadcastPrice" placeholder="Price" class="w-full p-2 mb-2 rounded bg-gray-900" />
          <button id="broadcastBtn" class="btn btn-primary w-full">Send Broadcast</button>
        </div>

        <!-- Transactions -->
        <div class="card">
          <h3 class="font-semibold mb-2">Transactions</h3>
          <div class="list" id="txnList"></div>
          <button id="refreshTxBtn" class="btn btn-primary w-full mt-3">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const BACKEND = "https://protrader-backend-sbus.onrender.com";
    const ADMIN_SECRET = "supersecret123";

    const firebaseConfig = {
      apiKey: "AIzaSyC-Vt0JpfAMj9uTdZHXXyot2FvB4lQ_vvE",
      authDomain: "protraderhack-d67f0.firebaseapp.com",
      projectId: "protraderhack-d67f0",
      storageBucket: "protraderhack-d67f0.firebasestorage.app",
      messagingSenderId: "1062485216321",
      appId: "1:1062485216321:web:f34bb52a8acc0a75b24ac0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.getElementById('admLogin').onclick = async ()=>{
      const e=document.getElementById('admEmail').value;
      const p=document.getElementById('admPass').value;
      try { await auth.signInWithEmailAndPassword(e,p); }
      catch(err){ alert("Login failed: "+err.message); }
    };

    auth.onAuthStateChanged(async user=>{
      if(!user){ document.getElementById('loginCard').style.display=''; document.getElementById('panel').style.display='none'; document.getElementById('logoutBtn').classList.add('hidden'); }
      else{ document.getElementById('loginCard').style.display='none'; document.getElementById('panel').style.display=''; document.getElementById('logoutBtn').classList.remove('hidden'); loadKeys(); loadSignals(); loadTransactions(); }
    });

    document.getElementById('logoutBtn').onclick = ()=>auth.signOut();

    async function loadKeys(){
      const el=document.getElementById('keysList'); el.innerHTML='';
      const snap=await db.collection('keys').get();
      snap.forEach(d=>{
        const data=d.data(); const div=document.createElement('div');
        div.className="row"; div.innerHTML=`<div><strong>${d.id}</strong> — ${data.role||'user'} — exp:${data.expiry||'never'}</div>`;
        el.appendChild(div);
      });
    }

    document.getElementById('createKeyBtn').onclick=async()=>{
      const k=document.getElementById('newKeyVal').value||Math.random().toString(36).substring(2,10);
      const days=document.getElementById('newKeyDays').value;
      const expiry=days?new Date(Date.now()+days*24*3600*1000).toISOString():null;
      await db.collection('keys').doc(k).set({ role:'user', expiry });
      alert("Key created: "+k); loadKeys();
    };

    function loadSignals(){
      const el=document.getElementById('signalsList'); el.innerHTML='';
      db.collection('signals').orderBy('timestamp','desc').limit(30).onSnapshot(snap=>{
        el.innerHTML=''; snap.forEach(d=>{const s=d.data(); const div=document.createElement('div'); div.className="row"; div.innerHTML=`<div><strong>${s.symbol}</strong> ${s.signal} @ ${s.price||s.last_price}</div>`; el.appendChild(div); });
      });
    }

    document.getElementById('broadcastBtn').onclick=async()=>{
      const body={
        message:document.getElementById('broadcastMessage').value,
        symbol:document.getElementById('broadcastSymbol').value,
        signal:document.getElementById('broadcastSignal').value,
        price:document.getElementById('broadcastPrice').value
      };
      const res=await fetch(BACKEND+'/send_notification',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Secret':ADMIN_SECRET},body:JSON.stringify(body)});
      const data=await res.json();
      alert(res.ok?"Broadcast sent ✅":"Failed: "+data.error);
    };

    async function loadTransactions(){
      const el=document.getElementById('txnList'); el.innerHTML='Loading...';
      const res=await fetch(BACKEND+'/transactions'); const data=await res.json(); el.innerHTML='';
      data.forEach(t=>{
        const div=document.createElement('div'); div.className="row"; div.innerHTML=`<div><strong>${t.user}</strong> ${t.type} • ${t.broker}</div><div class="chip status-${t.status}">${t.status}</div>`;
        // Admin status controls
        const btnC=document.createElement('button'); btnC.className='btn btn-green'; btnC.innerText='✔'; btnC.onclick=async()=>updateTx(t.id,'completed');
        const btnP=document.createElement('button'); btnP.className='btn'; btnP.innerText='⏳'; btnP.onclick=async()=>updateTx(t.id,'processing');
        const btnX=document.createElement('button'); btnX.className='btn btn-red'; btnX.innerText='✖'; btnX.onclick=async()=>updateTx(t.id,'cancelled');
        div.appendChild(btnC); div.appendChild(btnP); div.appendChild(btnX);
        el.appendChild(div);
      });
    }
    document.getElementById('refreshTxBtn').onclick=loadTransactions;

    async function updateTx(id,status){
      const res=await fetch(BACKEND+'/transactions/'+id,{method:'PATCH',headers:{'Content-Type':'application/json','X-Admin-Secret':ADMIN_SECRET},body:JSON.stringify({status})});
      if(res.ok){ alert("Updated to "+status); loadTransactions(); }
      else{ const d=await res.json(); alert("Error: "+d.error); }
    }
  </script>
</body>
</html>
